diff --git a/.gitignore b/.gitignore
index d650fc6..080396d 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1,2 +1,2 @@
 models/
-data/raw/
+data/
diff --git a/README.md b/README.md
index 9815505..05c5c7f 100644
--- a/README.md
+++ b/README.md
@@ -2,15 +2,15 @@
 
 1. 运行 `setup_environment.sh` 以配置环境：
    ```bash
-   sh scripts/setup_environment.sh
+   source scripts/setup_environment.sh
    ```
 
 2. 运行 `download_model.sh` 下载模型文件：
     ```bash
-    sh scripts/download_model.sh
+    source scripts/download_model.sh
     ```
     
 3. 运行 `download_data.sh` 下载数据文件：
     ```bash
-    sh scripts/download_data.sh
+    source scripts/download_data.sh
     ```
\ No newline at end of file
diff --git a/scripts/download_data.sh b/scripts/download_data.sh
index 53ea345..db92c3b 100644
--- a/scripts/download_data.sh
+++ b/scripts/download_data.sh
@@ -3,9 +3,12 @@
 # 设置脚本为严格模式，遇到错误时立即退出, 打印错误信息
 set -ex
 
+ENV_NAME="finbot"
+
 echo "开启代理, 如果没有需手动下载"
 source /etc/profile.d/clash.sh
 proxy_on
+conda acitvate $ENV_NAME
 
 echo "股价数据"
 wget https://github.com/chenditc/investment_data/releases/download/2024-08-09/qlib_bin.tar.gz
diff --git a/scripts/download_model.sh b/scripts/download_model.sh
index e6264b1..bfdb736 100644
--- a/scripts/download_model.sh
+++ b/scripts/download_model.sh
@@ -3,9 +3,12 @@
 # 设置脚本为严格模式，遇到错误时立即退出, 打印错误信息
 set -ex
 
+ENV_NAME="finbot"
+
 # 下载开源模型
 echo "Downloading models"
 mkdir -p models
+conda acitvate $ENV_NAME
 
 download_model() {
     local source="$1" 
diff --git a/scripts/setup_environment.sh b/scripts/setup_environment.sh
index ec30ec1..2306c89 100644
--- a/scripts/setup_environment.sh
+++ b/scripts/setup_environment.sh
@@ -5,48 +5,16 @@ set -ex
 
 # 定义环境名称和 Python 版本
 ENV_NAME="finbot"
-PYTHON_VERSION="3.10"
+PYTHON_VERSION="3.8"  ## pyqlib需要version=3.8
 
-# 创建并激活环境
+# 创建环境并激活
 echo "Creating Conda environment '$ENV_NAME' with Python $PYTHON_VERSION..."
 conda create -n $ENV_NAME python=$PYTHON_VERSION notebook -y
-source activate $ENV_NAME
+conda activate $ENV_NAME
 
-# 安装 Python 包
+# 在环境中安装 Python 包
 echo "Installing Python packages..."
 export PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
-pip install vllm modelscope hf_transfer matplotlib
-
-# 下载开源模型
-echo "Downloading models"
-mkdir -p models
-
-download_model() {
-    local source="$1" 
-    local model_name="$2"
-    local model_dir="$3"
-    echo "Downloading $model_name from $source to ./models/$model_dir..."
-    if [ "$source" = "modelscope" ]; then
-        modelscope download --model "$model_name" --local_dir "./models/$model_dir"
-    elif [ "$source" = "hf" ]; then
-        export HF_ENDPOINT=https://hf-mirror.com
-        export HF_HUB_ENABLE_HF_TRANSFER=1  # 激活huggingface-cli加速模块, 网络不好可关掉
-        huggingface-cli download --resume-download --local-dir-use-symlinks False \
-        "$model_name" --local-dir "./models/$model_dir"
-    else
-        echo "Error: Unsupported model source '$source'."
-        echo " Please use 'modelscope' or 'hf'."
-        return 1  # 返回非零值表示出错
-    fi
-}
-
-download_model modelscope BAAI/bge-large-zh-v1.5 bge-large-zh-v1.5
-download_model modelscope Qwen/Qwen2.5-3B-Instruct Qwen2.5-3B-Instruct
-download_model modelscope qolaris/FinBert FinBert
-
-## huggingface容易下载慢/卡住, 可以清楚缓存再单独跑
-download_model hf ProsusAI/finbert FinBert
-download_model hf openbmb/MiniCPM3-4B MiniCPM3-4B
-
+pip install vllm modelscope hf_transfer matplotlib pyqlib catboost xgboost openpyxl
 
 echo "Setup complete!"
diff --git "a/train/\346\203\205\346\204\237\346\217\220\345\217\226.ipynb" "b/train/\346\203\205\346\204\237\346\217\220\345\217\226.ipynb"
index 3543c89..2abbf5c 100644
--- "a/train/\346\203\205\346\204\237\346\217\220\345\217\226.ipynb"
+++ "b/train/\346\203\205\346\204\237\346\217\220\345\217\226.ipynb"
@@ -2,7 +2,7 @@
  "cells": [
   {
    "cell_type": "code",
-   "execution_count": 1,
+   "execution_count": 11,
    "metadata": {},
    "outputs": [
     {
@@ -27,7 +27,7 @@
   },
   {
    "cell_type": "code",
-   "execution_count": 5,
+   "execution_count": 12,
    "metadata": {},
    "outputs": [],
    "source": [
@@ -175,7 +175,7 @@
   },
   {
    "cell_type": "code",
-   "execution_count": 7,
+   "execution_count": 13,
    "metadata": {},
    "outputs": [],
    "source": [
@@ -193,7 +193,7 @@
   },
   {
    "cell_type": "code",
-   "execution_count": 10,
+   "execution_count": 14,
    "metadata": {},
    "outputs": [],
    "source": [
@@ -241,7 +241,7 @@
   },
   {
    "cell_type": "code",
-   "execution_count": 9,
+   "execution_count": 15,
    "metadata": {},
    "outputs": [
     {
@@ -439,7 +439,7 @@
    "name": "python",
    "nbconvert_exporter": "python",
    "pygments_lexer": "ipython3",
-   "version": "3.10.15"
+   "version": "3.8.20"
   }
  },
  "nbformat": 4,
diff --git "a/train/\350\202\241\344\273\267\351\242\204\346\265\213.ipynb" "b/train/\350\202\241\344\273\267\351\242\204\346\265\213.ipynb"
index 0afe809..82f9aae 100644
--- "a/train/\350\202\241\344\273\267\351\242\204\346\265\213.ipynb"
+++ "b/train/\350\202\241\344\273\267\351\242\204\346\265\213.ipynb"
@@ -1,5 +1,302 @@
 {
- "cells": [],
+ "cells": [
+  {
+   "cell_type": "code",
+   "execution_count": 1,
+   "metadata": {},
+   "outputs": [],
+   "source": [
+    "# import qlib\n",
+    "# from qlib.workflow import R\n",
+    "# qlib.init(provider_uri = \"../data/raw/qlib_data/cn_data\", region = \"cn\")\n",
+    "# R.set_uri(None) ## 关闭qlib的实验管理记录"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 2,
+   "metadata": {},
+   "outputs": [],
+   "source": [
+    "# from qlib.data import D\n",
+    "# import os\n",
+    "# df = D.features(\n",
+    "#     D.instruments(\"csi300\"),\n",
+    "#     fields=['$adjclose','$amount','$change','$close','$factor','$high','$low','$open','$volume','$vwap'],\n",
+    "#     start_time=\"2016-01-01\",\n",
+    "#     end_time=\"2020-12-31\"\n",
+    "# )\n",
+    "# if not os.path.exists(cleaned_data_path:= '../data/cleaned/csi300_stock_feats.csv'):\n",
+    "#     df.reset_index(inplace=True)\n",
+    "#     df['datetime'] = df['datetime'].dt.strftime('%Y-%m-%d')\n",
+    "#     df.to_csv(cleaned_data_path, index=False, float_format='%.5f')\n",
+    "# df"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 1,
+   "metadata": {},
+   "outputs": [
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "[268215:MainThread](2024-11-06 10:43:08,328) INFO - qlib.Initialization - [config.py:416] - default_conf: client.\n",
+      "[268215:MainThread](2024-11-06 10:43:08,680) INFO - qlib.Initialization - [__init__.py:74] - qlib successfully initialized based on client settings.\n",
+      "[268215:MainThread](2024-11-06 10:43:08,681) INFO - qlib.Initialization - [__init__.py:76] - data_path={'__DEFAULT_FREQ': PosixPath('/mnt/disk1/JXH/02_workspace/毕设_量化智能助手/data/raw/qlib_data/cn_data')}\n",
+      "[268215:MainThread](2024-11-06 10:43:24,762) INFO - qlib.timer - [log.py:127] - Time cost: 16.079s | Loading data Done\n",
+      "[268215:MainThread](2024-11-06 10:43:24,764) INFO - qlib.timer - [log.py:127] - Time cost: 0.000s | fit & process data Done\n",
+      "[268215:MainThread](2024-11-06 10:43:24,765) INFO - qlib.timer - [log.py:127] - Time cost: 16.083s | Init data Done\n"
+     ]
+    }
+   ],
+   "source": [
+    "import qlib\n",
+    "import pandas as pd\n",
+    "from qlib.contrib.data.handler import Alpha158\n",
+    "from qlib.data.dataset.handler import DataHandlerLP\n",
+    "from qlib.data.dataset.loader import StaticDataLoader, QlibDataLoader\n",
+    "from qlib.data.dataset import DatasetH\n",
+    "\n",
+    "## 特征与标签配置\n",
+    "feature_config = Alpha158.parse_config_to_fields(dict(price={\"windows\": [0],\"feature\": [\"OPEN\", \"HIGH\", \"LOW\", \"VWAP\"]},rolling={},kbar={}))\n",
+    "label_config = ([\"Ref($close, -1)/$close-1\"],['LABEL0']) \n",
+    "\n",
+    "## 加载数据\n",
+    "qlib.init(provider_uri = \"../data/raw/qlib_data/cn_data\")\n",
+    "dl = QlibDataLoader(config = {\"feature\":feature_config, \"label\":label_config})\n",
+    "# df = pd.read_csv('../data/cleaned/csi300_stock_feats.csv', index_col=[\"instrument\",\"datetime\"])\n",
+    "# dl = StaticDataLoader(config=df)\n",
+    "\n",
+    "## 创建数据处理器\n",
+    "dh = DataHandlerLP(\n",
+    "    instruments='csi300', \n",
+    "    start_time='20190101', \n",
+    "    end_time='20211231',\n",
+    "    data_loader=dl\n",
+    ")\n",
+    "\n",
+    "## 创建数据集\n",
+    "ds = DatasetH(handler=dh,segments={\"train\": ('20190101', '20201231'), \"test\": ('20210101', '20211231')})"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 2,
+   "metadata": {},
+   "outputs": [
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "/mnt/disk1/JXH/01_apps/miniforge3/envs/finbot/lib/python3.8/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html\n",
+      "  from .autonotebook import tqdm as notebook_tqdm\n"
+     ]
+    }
+   ],
+   "source": [
+    "from qlib.contrib.model.gbdt import LGBModel\n",
+    "model = LGBModel(\n",
+    "    loss=\"mse\",\n",
+    "    colsample_bytree=0.8879,\n",
+    "    learning_rate=0.0421,\n",
+    "    subsample=0.8789,\n",
+    "    lambda_l1=205.6999,\n",
+    "    lambda_l2=580.9768,\n",
+    "    max_depth=8,\n",
+    "    num_leaves=210,\n",
+    "    num_threads=20,\n",
+    ")"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 5,
+   "metadata": {},
+   "outputs": [
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "/mnt/disk1/JXH/01_apps/miniforge3/envs/finbot/lib/python3.8/site-packages/lightgbm/callback.py:341: UserWarning: Only training set found, disabling early stopping.\n",
+      "  _log_warning(\"Only training set found, disabling early stopping.\")\n"
+     ]
+    },
+    {
+     "name": "stdout",
+     "output_type": "stream",
+     "text": [
+      "[20]\ttrain's l2: 0.000593183\n",
+      "[40]\ttrain's l2: 0.000593183\n",
+      "[60]\ttrain's l2: 0.000593183\n",
+      "[80]\ttrain's l2: 0.000593183\n",
+      "[100]\ttrain's l2: 0.000593183\n",
+      "[120]\ttrain's l2: 0.000593183\n",
+      "[140]\ttrain's l2: 0.000593183\n",
+      "[160]\ttrain's l2: 0.000593183\n",
+      "[180]\ttrain's l2: 0.000593183\n",
+      "[200]\ttrain's l2: 0.000593183\n",
+      "[220]\ttrain's l2: 0.000593183\n",
+      "[240]\ttrain's l2: 0.000593183\n",
+      "[260]\ttrain's l2: 0.000593183\n",
+      "[280]\ttrain's l2: 0.000593183\n",
+      "[300]\ttrain's l2: 0.000593183\n",
+      "[320]\ttrain's l2: 0.000593183\n",
+      "[340]\ttrain's l2: 0.000593183\n",
+      "[360]\ttrain's l2: 0.000593183\n",
+      "[380]\ttrain's l2: 0.000593183\n",
+      "[400]\ttrain's l2: 0.000593183\n",
+      "[420]\ttrain's l2: 0.000593183\n",
+      "[440]\ttrain's l2: 0.000593183\n",
+      "[460]\ttrain's l2: 0.000593183\n",
+      "[480]\ttrain's l2: 0.000593183\n",
+      "[500]\ttrain's l2: 0.000593183\n",
+      "[520]\ttrain's l2: 0.000593183\n",
+      "[540]\ttrain's l2: 0.000593183\n",
+      "[560]\ttrain's l2: 0.000593183\n",
+      "[580]\ttrain's l2: 0.000593183\n",
+      "[600]\ttrain's l2: 0.000593183\n",
+      "[620]\ttrain's l2: 0.000593183\n",
+      "[640]\ttrain's l2: 0.000593183\n",
+      "[660]\ttrain's l2: 0.000593183\n",
+      "[680]\ttrain's l2: 0.000593183\n",
+      "[700]\ttrain's l2: 0.000593183\n",
+      "[720]\ttrain's l2: 0.000593183\n",
+      "[740]\ttrain's l2: 0.000593183\n",
+      "[760]\ttrain's l2: 0.000593183\n",
+      "[780]\ttrain's l2: 0.000593183\n",
+      "[800]\ttrain's l2: 0.000593183\n",
+      "[820]\ttrain's l2: 0.000593183\n",
+      "[840]\ttrain's l2: 0.000593183\n",
+      "[860]\ttrain's l2: 0.000593183\n",
+      "[880]\ttrain's l2: 0.000593183\n",
+      "[900]\ttrain's l2: 0.000593183\n",
+      "[920]\ttrain's l2: 0.000593183\n",
+      "[940]\ttrain's l2: 0.000593183\n",
+      "[960]\ttrain's l2: 0.000593183\n"
+     ]
+    },
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "[230569:MainThread](2024-11-06 09:01:16,203) INFO - qlib.workflow - [exp.py:258] - Experiment 3 starts running ...\n"
+     ]
+    },
+    {
+     "name": "stdout",
+     "output_type": "stream",
+     "text": [
+      "[980]\ttrain's l2: 0.000593183\n",
+      "[1000]\ttrain's l2: 0.000593183\n"
+     ]
+    },
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "[230569:MainThread](2024-11-06 09:01:16,444) INFO - qlib.workflow - [recorder.py:341] - Recorder 7ebb51c15bf84fa28a4ff906b20119a2 starts running under Experiment 3 ...\n"
+     ]
+    }
+   ],
+   "source": [
+    "# 训练模型\n",
+    "from qlib.workflow import R\n",
+    "with R.start(uri=None):\n",
+    "    model.fit(ds)"
+   ]
+  },
+  {
+   "cell_type": "code",
+   "execution_count": null,
+   "metadata": {},
+   "outputs": [],
+   "source": []
+  },
+  {
+   "cell_type": "code",
+   "execution_count": 6,
+   "metadata": {},
+   "outputs": [
+    {
+     "name": "stderr",
+     "output_type": "stream",
+     "text": [
+      "[230569:MainThread](2024-11-06 09:01:16,831) INFO - qlib.workflow - [exp.py:258] - Experiment 2 starts running ...\n"
+     ]
+    },
+    {
+     "ename": "Exception",
+     "evalue": "Run with UUID 7ebb51c15bf84fa28a4ff906b20119a2 is already active. To start a new run, first end the current run with mlflow.end_run(). To start a nested run, call start_run with nested=True",
+     "output_type": "error",
+     "traceback": [
+      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
+      "\u001b[0;31mException\u001b[0m                                 Traceback (most recent call last)",
+      "Cell \u001b[0;32mIn[6], line 39\u001b[0m\n\u001b[1;32m      3\u001b[0m \u001b[38;5;28;01mfrom\u001b[39;00m \u001b[38;5;21;01mqlib\u001b[39;00m\u001b[38;5;21;01m.\u001b[39;00m\u001b[38;5;21;01mworkflow\u001b[39;00m\u001b[38;5;21;01m.\u001b[39;00m\u001b[38;5;21;01mrecord_temp\u001b[39;00m \u001b[38;5;28;01mimport\u001b[39;00m SignalRecord, PortAnaRecord\n\u001b[1;32m      4\u001b[0m port_analysis_config \u001b[38;5;241m=\u001b[39m {\n\u001b[1;32m      5\u001b[0m     \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mexecutor\u001b[39m\u001b[38;5;124m\"\u001b[39m: {\n\u001b[1;32m      6\u001b[0m         \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mclass\u001b[39m\u001b[38;5;124m\"\u001b[39m: \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mSimulatorExecutor\u001b[39m\u001b[38;5;124m\"\u001b[39m,\n\u001b[0;32m   (...)\u001b[0m\n\u001b[1;32m     36\u001b[0m     },\n\u001b[1;32m     37\u001b[0m }\n\u001b[0;32m---> 39\u001b[0m \u001b[38;5;28;01mwith\u001b[39;00m R\u001b[38;5;241m.\u001b[39mstart(experiment_name\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mbacktest_analysis\u001b[39m\u001b[38;5;124m\"\u001b[39m):\n\u001b[1;32m     40\u001b[0m     \u001b[38;5;66;03m# prediction\u001b[39;00m\n\u001b[1;32m     41\u001b[0m     recorder \u001b[38;5;241m=\u001b[39m R\u001b[38;5;241m.\u001b[39mget_recorder()\n\u001b[1;32m     42\u001b[0m     sr \u001b[38;5;241m=\u001b[39m SignalRecord(model, ds)\n",
+      "File \u001b[0;32m/mnt/disk1/JXH/01_apps/miniforge3/envs/finbot/lib/python3.8/contextlib.py:113\u001b[0m, in \u001b[0;36m_GeneratorContextManager.__enter__\u001b[0;34m(self)\u001b[0m\n\u001b[1;32m    111\u001b[0m \u001b[38;5;28;01mdel\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39margs, \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mkwds, \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mfunc\n\u001b[1;32m    112\u001b[0m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[0;32m--> 113\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mnext\u001b[39;49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mgen\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    114\u001b[0m \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mStopIteration\u001b[39;00m:\n\u001b[1;32m    115\u001b[0m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mRuntimeError\u001b[39;00m(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mgenerator didn\u001b[39m\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mt yield\u001b[39m\u001b[38;5;124m\"\u001b[39m) \u001b[38;5;28;01mfrom\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m\n",
+      "File \u001b[0;32m/mnt/disk1/JXH/01_apps/miniforge3/envs/finbot/lib/python3.8/site-packages/qlib/workflow/__init__.py:69\u001b[0m, in \u001b[0;36mQlibRecorder.start\u001b[0;34m(self, experiment_id, experiment_name, recorder_id, recorder_name, uri, resume)\u001b[0m\n\u001b[1;32m     24\u001b[0m \u001b[38;5;129m@contextmanager\u001b[39m\n\u001b[1;32m     25\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m \u001b[38;5;21mstart\u001b[39m(\n\u001b[1;32m     26\u001b[0m     \u001b[38;5;28mself\u001b[39m,\n\u001b[0;32m   (...)\u001b[0m\n\u001b[1;32m     33\u001b[0m     resume: \u001b[38;5;28mbool\u001b[39m \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;01mFalse\u001b[39;00m,\n\u001b[1;32m     34\u001b[0m ):\n\u001b[1;32m     35\u001b[0m \u001b[38;5;250m    \u001b[39m\u001b[38;5;124;03m\"\"\"\u001b[39;00m\n\u001b[1;32m     36\u001b[0m \u001b[38;5;124;03m    Method to start an experiment. This method can only be called within a Python's `with` statement. Here is the example code:\u001b[39;00m\n\u001b[1;32m     37\u001b[0m \n\u001b[0;32m   (...)\u001b[0m\n\u001b[1;32m     67\u001b[0m \u001b[38;5;124;03m        whether to resume the specific recorder with given name under the given experiment.\u001b[39;00m\n\u001b[1;32m     68\u001b[0m \u001b[38;5;124;03m    \"\"\"\u001b[39;00m\n\u001b[0;32m---> 69\u001b[0m     run \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mstart_exp\u001b[49m\u001b[43m(\u001b[49m\n\u001b[1;32m     70\u001b[0m \u001b[43m        \u001b[49m\u001b[43mexperiment_id\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mexperiment_id\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     71\u001b[0m \u001b[43m        \u001b[49m\u001b[43mexperiment_name\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mexperiment_name\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     72\u001b[0m \u001b[43m        \u001b[49m\u001b[43mrecorder_id\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mrecorder_id\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     73\u001b[0m \u001b[43m        \u001b[49m\u001b[43mrecorder_name\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mrecorder_name\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     74\u001b[0m \u001b[43m        \u001b[49m\u001b[43muri\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43muri\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     75\u001b[0m \u001b[43m        \u001b[49m\u001b[43mresume\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mresume\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     76\u001b[0m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m     77\u001b[0m     \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[1;32m     78\u001b[0m         \u001b[38;5;28;01myield\u001b[39;00m run\n",
+      "File \u001b[0;32m/mnt/disk1/JXH/01_apps/miniforge3/envs/finbot/lib/python3.8/site-packages/qlib/workflow/__init__.py:125\u001b[0m, in \u001b[0;36mQlibRecorder.start_exp\u001b[0;34m(self, experiment_id, experiment_name, recorder_id, recorder_name, uri, resume)\u001b[0m\n\u001b[1;32m     84\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m \u001b[38;5;21mstart_exp\u001b[39m(\n\u001b[1;32m     85\u001b[0m     \u001b[38;5;28mself\u001b[39m,\n\u001b[1;32m     86\u001b[0m     \u001b[38;5;241m*\u001b[39m,\n\u001b[0;32m   (...)\u001b[0m\n\u001b[1;32m     92\u001b[0m     resume\u001b[38;5;241m=\u001b[39m\u001b[38;5;28;01mFalse\u001b[39;00m,\n\u001b[1;32m     93\u001b[0m ):\n\u001b[1;32m     94\u001b[0m \u001b[38;5;250m    \u001b[39m\u001b[38;5;124;03m\"\"\"\u001b[39;00m\n\u001b[1;32m     95\u001b[0m \u001b[38;5;124;03m    Lower level method for starting an experiment. When use this method, one should end the experiment manually\u001b[39;00m\n\u001b[1;32m     96\u001b[0m \u001b[38;5;124;03m    and the status of the recorder may not be handled properly. Here is the example code:\u001b[39;00m\n\u001b[0;32m   (...)\u001b[0m\n\u001b[1;32m    123\u001b[0m \u001b[38;5;124;03m    An experiment instance being started.\u001b[39;00m\n\u001b[1;32m    124\u001b[0m \u001b[38;5;124;03m    \"\"\"\u001b[39;00m\n\u001b[0;32m--> 125\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mexp_manager\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mstart_exp\u001b[49m\u001b[43m(\u001b[49m\n\u001b[1;32m    126\u001b[0m \u001b[43m        \u001b[49m\u001b[43mexperiment_id\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mexperiment_id\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m    127\u001b[0m \u001b[43m        \u001b[49m\u001b[43mexperiment_name\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mexperiment_name\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m    128\u001b[0m \u001b[43m        \u001b[49m\u001b[43mrecorder_id\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mrecorder_id\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m    129\u001b[0m \u001b[43m        \u001b[49m\u001b[43mrecorder_name\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mrecorder_name\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m    130\u001b[0m \u001b[43m        \u001b[49m\u001b[43muri\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43muri\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m    131\u001b[0m \u001b[43m        \u001b[49m\u001b[43mresume\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mresume\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m    132\u001b[0m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n",
+      "File \u001b[0;32m/mnt/disk1/JXH/01_apps/miniforge3/envs/finbot/lib/python3.8/site-packages/qlib/workflow/expm.py:85\u001b[0m, in \u001b[0;36mExpManager.start_exp\u001b[0;34m(self, experiment_id, experiment_name, recorder_id, recorder_name, uri, resume, **kwargs)\u001b[0m\n\u001b[1;32m     82\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39m_active_exp_uri \u001b[38;5;241m=\u001b[39m uri\n\u001b[1;32m     83\u001b[0m \u001b[38;5;66;03m# The subclass may set the underlying uri back.\u001b[39;00m\n\u001b[1;32m     84\u001b[0m \u001b[38;5;66;03m# So setting `_active_exp_uri` come before `_start_exp`\u001b[39;00m\n\u001b[0;32m---> 85\u001b[0m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43m_start_exp\u001b[49m\u001b[43m(\u001b[49m\n\u001b[1;32m     86\u001b[0m \u001b[43m    \u001b[49m\u001b[43mexperiment_id\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mexperiment_id\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     87\u001b[0m \u001b[43m    \u001b[49m\u001b[43mexperiment_name\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mexperiment_name\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     88\u001b[0m \u001b[43m    \u001b[49m\u001b[43mrecorder_id\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mrecorder_id\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     89\u001b[0m \u001b[43m    \u001b[49m\u001b[43mrecorder_name\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mrecorder_name\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     90\u001b[0m \u001b[43m    \u001b[49m\u001b[43mresume\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mresume\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     91\u001b[0m \u001b[43m    \u001b[49m\u001b[38;5;241;43m*\u001b[39;49m\u001b[38;5;241;43m*\u001b[39;49m\u001b[43mkwargs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[1;32m     92\u001b[0m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n",
+      "File \u001b[0;32m/mnt/disk1/JXH/01_apps/miniforge3/envs/finbot/lib/python3.8/site-packages/qlib/workflow/expm.py:344\u001b[0m, in \u001b[0;36mMLflowExpManager._start_exp\u001b[0;34m(self, experiment_id, experiment_name, recorder_id, recorder_name, resume)\u001b[0m\n\u001b[1;32m    342\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mactive_experiment \u001b[38;5;241m=\u001b[39m experiment\n\u001b[1;32m    343\u001b[0m \u001b[38;5;66;03m# Start the experiment\u001b[39;00m\n\u001b[0;32m--> 344\u001b[0m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mactive_experiment\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mstart\u001b[49m\u001b[43m(\u001b[49m\u001b[43mrecorder_id\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mrecorder_id\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mrecorder_name\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mrecorder_name\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mresume\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mresume\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    346\u001b[0m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mactive_experiment\n",
+      "File \u001b[0;32m/mnt/disk1/JXH/01_apps/miniforge3/envs/finbot/lib/python3.8/site-packages/qlib/workflow/exp.py:271\u001b[0m, in \u001b[0;36mMLflowExperiment.start\u001b[0;34m(self, recorder_id, recorder_name, resume)\u001b[0m\n\u001b[1;32m    269\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mactive_recorder \u001b[38;5;241m=\u001b[39m recorder\n\u001b[1;32m    270\u001b[0m \u001b[38;5;66;03m# Start the recorder\u001b[39;00m\n\u001b[0;32m--> 271\u001b[0m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mactive_recorder\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mstart_run\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    273\u001b[0m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mactive_recorder\n",
+      "File \u001b[0;32m/mnt/disk1/JXH/01_apps/miniforge3/envs/finbot/lib/python3.8/site-packages/qlib/workflow/recorder.py:335\u001b[0m, in \u001b[0;36mMLflowRecorder.start_run\u001b[0;34m(self)\u001b[0m\n\u001b[1;32m    333\u001b[0m mlflow\u001b[38;5;241m.\u001b[39mset_tracking_uri(\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39muri)\n\u001b[1;32m    334\u001b[0m \u001b[38;5;66;03m# start the run\u001b[39;00m\n\u001b[0;32m--> 335\u001b[0m run \u001b[38;5;241m=\u001b[39m \u001b[43mmlflow\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mstart_run\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mid\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mexperiment_id\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mname\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    336\u001b[0m \u001b[38;5;66;03m# save the run id and artifact_uri\u001b[39;00m\n\u001b[1;32m    337\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mid \u001b[38;5;241m=\u001b[39m run\u001b[38;5;241m.\u001b[39minfo\u001b[38;5;241m.\u001b[39mrun_id\n",
+      "File \u001b[0;32m/mnt/disk1/JXH/01_apps/miniforge3/envs/finbot/lib/python3.8/site-packages/mlflow/tracking/fluent.py:271\u001b[0m, in \u001b[0;36mstart_run\u001b[0;34m(run_id, experiment_id, run_name, nested, tags, description)\u001b[0m\n\u001b[1;32m    269\u001b[0m experiment_id \u001b[38;5;241m=\u001b[39m \u001b[38;5;28mstr\u001b[39m(experiment_id) \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(experiment_id, \u001b[38;5;28mint\u001b[39m) \u001b[38;5;28;01melse\u001b[39;00m experiment_id\n\u001b[1;32m    270\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mlen\u001b[39m(_active_run_stack) \u001b[38;5;241m>\u001b[39m \u001b[38;5;241m0\u001b[39m \u001b[38;5;129;01mand\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m nested:\n\u001b[0;32m--> 271\u001b[0m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mException\u001b[39;00m(\n\u001b[1;32m    272\u001b[0m         (\n\u001b[1;32m    273\u001b[0m             \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mRun with UUID \u001b[39m\u001b[38;5;132;01m{}\u001b[39;00m\u001b[38;5;124m is already active. To start a new run, first end the \u001b[39m\u001b[38;5;124m\"\u001b[39m\n\u001b[1;32m    274\u001b[0m             \u001b[38;5;241m+\u001b[39m \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mcurrent run with mlflow.end_run(). To start a nested \u001b[39m\u001b[38;5;124m\"\u001b[39m\n\u001b[1;32m    275\u001b[0m             \u001b[38;5;241m+\u001b[39m \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mrun, call start_run with nested=True\u001b[39m\u001b[38;5;124m\"\u001b[39m\n\u001b[1;32m    276\u001b[0m         )\u001b[38;5;241m.\u001b[39mformat(_active_run_stack[\u001b[38;5;241m0\u001b[39m]\u001b[38;5;241m.\u001b[39minfo\u001b[38;5;241m.\u001b[39mrun_id)\n\u001b[1;32m    277\u001b[0m     )\n\u001b[1;32m    278\u001b[0m client \u001b[38;5;241m=\u001b[39m MlflowClient()\n\u001b[1;32m    279\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m run_id:\n",
+      "\u001b[0;31mException\u001b[0m: Run with UUID 7ebb51c15bf84fa28a4ff906b20119a2 is already active. To start a new run, first end the current run with mlflow.end_run(). To start a nested run, call start_run with nested=True"
+     ]
+    }
+   ],
+   "source": [
+    "## 回测分析\n",
+    "from qlib.workflow import R\n",
+    "from qlib.workflow.record_temp import SignalRecord, PortAnaRecord\n",
+    "port_analysis_config = {\n",
+    "    \"executor\": {\n",
+    "        \"class\": \"SimulatorExecutor\",\n",
+    "        \"module_path\": \"qlib.backtest.executor\",\n",
+    "        \"kwargs\": {\n",
+    "            \"time_per_step\": \"day\",\n",
+    "            \"generate_portfolio_metrics\": True,\n",
+    "        },\n",
+    "    },\n",
+    "    \"strategy\": {\n",
+    "        \"class\": \"TopkDropoutStrategy\",\n",
+    "        \"module_path\": \"qlib.contrib.strategy.signal_strategy\",\n",
+    "        \"kwargs\": {\n",
+    "            \"model\": model,\n",
+    "            \"dataset\": ds,\n",
+    "            \"topk\": 50,\n",
+    "            \"n_drop\": 5,\n",
+    "        },\n",
+    "    },\n",
+    "    \"backtest\": {\n",
+    "        \"start_time\": \"2017-01-01\",\n",
+    "        \"end_time\": \"2020-08-01\",\n",
+    "        \"account\": 100000000,\n",
+    "        \"benchmark\": \"SH000300\",\n",
+    "        \"exchange_kwargs\": {\n",
+    "            \"freq\": \"day\",\n",
+    "            \"limit_threshold\": 0.095,\n",
+    "            \"deal_price\": \"close\",\n",
+    "            \"open_cost\": 0.0005,\n",
+    "            \"close_cost\": 0.0015,\n",
+    "            \"min_cost\": 5,\n",
+    "        },\n",
+    "    },\n",
+    "}\n",
+    "\n",
+    "with R.start(experiment_name=\"backtest_analysis\"):\n",
+    "    # prediction\n",
+    "    recorder = R.get_recorder()\n",
+    "    sr = SignalRecord(model, ds)\n",
+    "    sr.generate()\n",
+    "\n",
+    "    # backtest & analysis\n",
+    "    par = PortAnaRecord(recorder, port_analysis_config, \"day\")\n",
+    "    par.generate()"
+   ]
+  }
+ ],
  "metadata": {
   "kernelspec": {
    "display_name": "finbot",
@@ -16,7 +313,7 @@
    "name": "python",
    "nbconvert_exporter": "python",
    "pygments_lexer": "ipython3",
-   "version": "3.10.15"
+   "version": "3.8.20"
   }
  },
  "nbformat": 4,
